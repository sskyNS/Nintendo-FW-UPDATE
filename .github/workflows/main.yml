name: ğŸ® Firmware Auto Downloader (Fixed URL)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: RSS Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          set +e 
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Execute download script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          python3 firmware_downloader.py | tee firmware_output.txt
          tail -n 6 firmware_output.txt > changelog_body.txt

      - name: Clean and Re-pack (Fix Size 600MB -> 340MB)
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "Cleaning up possible duplicate zips..."
          
          # å…³é”®ä¿®å¤æ­¥éª¤ï¼š
          # ä½¿ç”¨ find å‘½ä»¤é€’å½’æŸ¥æ‰¾æ‰€æœ‰ .zip æ–‡ä»¶å¹¶å¼ºåˆ¶åˆ é™¤
          # è¿™ç¡®ä¿äº†æ— è®ºè„šæœ¬æŠŠ zip ç”Ÿæˆåœ¨å“ªé‡Œï¼ˆæ ¹ç›®å½•è¿˜æ˜¯å­ç›®å½•ï¼‰ï¼Œéƒ½ä¼šè¢«æ¸…é™¤
          find . -name "*.zip" -type f -delete
          
          # æ‰¾åˆ°å­˜æ”¾å›ºä»¶æ–‡ä»¶çš„ç›®å½• (é€šå¸¸æ˜¯ä»¥ Firmware å¼€å¤´çš„)
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
            echo "::error::Firmware folder not found."
            exit 1
          fi
          
          echo "Target folder: $FIRMWARE_FOLDER"
          
          # æ£€æŸ¥æ–‡ä»¶å¤¹å¤§å°ï¼ˆè°ƒè¯•ç”¨ï¼‰
          du -sh "$FIRMWARE_FOLDER"
          
          # é‡æ–°æ‰“åŒ…
          # -r: é€’å½’
          # -9: æœ€é«˜å‹ç¼©æ¯”
          # -q: å®‰é™æ¨¡å¼
          zip -r -9 -q Firmware.zip "$FIRMWARE_FOLDER"
          
          echo "Final Zip Size:"
          ls -lh Firmware.zip

      - name: Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const body = fs.readFileSync('changelog_body.txt', 'utf8').trim();
              core.setOutput('release_body', body);
            } catch (error) {
              core.setOutput('release_body', 'No details available.');
            }

      - name: Update Latest Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ${{ steps.version_check.outputs.new_version }}
          body: |
            æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.new_version }}
            è¯¥å›ºä»¶å·²è‡ªåŠ¨ä»ä»»å¤©å ‚å®˜æ–¹æœåŠ¡å™¨ä¸‹è½½ã€æ ¡éªŒå¹¶é‡æ–°æ‰“åŒ…ã€‚
            æ›´æ–°è¯¦æƒ…ï¼š
            ${{ steps.prepare_body.outputs.release_body }}
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
