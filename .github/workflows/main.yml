name: Firmware Auto Downloader (Fixed)

on:
  schedule:
    - cron: '0 * * * *' # 每小时检查一次，但只有新固件才会触发发布
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      force_update:
        description: '强制更新'
        required: false
        default: false
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4
          sudo apt-get update
          sudo apt-get install -y aria2

      - name: Install GitHub CLI
        run: sudo apt install gh -y

      - name: Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 获取官方 RSS 最新版本
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | grep '<title>Switch ' | grep -v 'Switch 2' | head -n 1)
          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # 获取当前 Release 的版本号 (去除 "Firmware " 前缀进行纯数字比对)
          CURRENT_RELEASE_NAME=$(gh release view latest --json name --jq '.name' 2>/dev/null || echo "0.0.0")
          CURRENT_VERSION=$(echo "$CURRENT_RELEASE_NAME" | sed 's/Firmware //g')
          
          echo "INFO: Latest RSS: $NEW_VERSION | Current Release: $CURRENT_VERSION"

          # 比对逻辑
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
             echo "update_needed=true" >> $GITHUB_OUTPUT
          elif [ "$NEW_VERSION" != "$CURRENT_VERSION" ] && [ ! -z "$NEW_VERSION" ]; then
             echo "update_needed=true" >> $GITHUB_OUTPUT
          else
             echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Execute download script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # 确保 keys 目录和必要文件存在 (假设你在仓库里存了证书或模拟了环境)
          python3 firmware_downloader.py "$NEW_VERSION" | tee firmware_output.txt

      - name: Process firmware files
        id: process_files
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          if [ -z "$FIRMWARE_FOLDER" ]; then echo "Folder not found"; exit 1; fi
          
          # 压缩
          (cd "$FIRMWARE_FOLDER" && zip -r -9 ../Firmware.zip .)
          
          echo "zip_size=$(stat -c%s Firmware.zip)" >> $GITHUB_OUTPUT
          echo "sha256_hash=$(sha256sum Firmware.zip | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      - name: Prepare release information
        id: prep_release
        if: steps.version_check.outputs.update_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 关键步骤：累加下载量
          PREV_DATA=$(gh release view latest --json body,assets 2>/dev/null || echo '{"body":"","assets":[]}')
          # 从 Body 寻找历史存留值
          HISTORY_BASE=$(echo "$PREV_DATA" | jq -r '.body' | grep -oP 'history_downloads:\s*\K[0-9]+' || echo "0")
          # 获取当前 Release 下所有文件的下载量之和
          CURRENT_DL_COUNT=$(echo "$PREV_DATA" | jq -r '[.assets[].download_count] | add' 2>/dev/null || echo "0")
          
          NEW_TOTAL_HISTORY=$((HISTORY_BASE + CURRENT_DL_COUNT))
          echo "History: $HISTORY_BASE + Current: $CURRENT_DL_COUNT = New: $NEW_TOTAL_HISTORY"

          # 读取脚本生成的 info
          source <(sed 's/=/="/;s/$/"/' firmware_info.txt)
          
          SIZE_MB=$(echo "scale=2; $SIZE_BYTES / 1048576" | bc)
          ZIP_SIZE_MB=$(echo "scale=2; ${{ steps.process_files.outputs.zip_size }} / 1048576" | bc)

          {
            echo "release_body<<EOF"
            echo "## Firmware $VERSION"
            echo "Automatic build from Nintendo servers."
            echo ""
            echo "### Build Info"
            echo "| Property | Value |"
            echo "| :--- | :--- |"
            echo "| **Files** | $FILES |"
            echo "| **Zip Size** | ${ZIP_SIZE_MB} MB |"
            echo "| **SHA256** | \`${{ steps.process_files.outputs.sha256_hash }}\` |"
            echo ""
            echo "### Changelog"
            echo "> $CHANGELOG"
            echo ""
            echo "<!-- history_downloads: $NEW_TOTAL_HISTORY -->"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Firmware ${{ env.NEW_VERSION }}
          body: ${{ steps.prep_release.outputs.release_body }}
          files: Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
