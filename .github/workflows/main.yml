name: ğŸ® Firmware Auto Downloader (Fixed URL)

on:
  # 1. æ¯å¤©æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'
  
  # 2. å½“ä»£ç æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ (å¿½ç•¥æ–‡æ¡£ä¿®æ”¹)
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'

  # 3. å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®å¼ºåˆ¶è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # âš ï¸ è¯»å†™æƒé™ç”¨äºå‘å¸ƒ Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- 1. è·å– RSS æœ€æ–°ç‰ˆæœ¬ ---
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::RSS feed error"
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: RSS Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # --- 2. å¼ºåˆ¶æ›´æ–°é€»è¾‘ (æ‰‹åŠ¨ æˆ– ä»£ç æ¨é€) ---
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†Forceï¼Œæˆ–è€…æ˜¯ä»£ç Pushè§¦å‘ï¼Œåˆ™å¼ºåˆ¶æ›´æ–°
          if [ "${{ github.event.inputs.force_update }}" == "true" ] || [ "${{ github.event_name }}" == "push" ]; then
             echo "INFO: Triggered by Manual Force or Code Push. Skipping version check."
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # --- 3. è·å–å½“å‰ Release ç‰ˆæœ¬ (å®šæ—¶ä»»åŠ¡é€»è¾‘) ---
          set +e 
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          # --- 4. æ¯”å¯¹ç‰ˆæœ¬ ---
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: Version match ($NEW_VERSION). No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: New version found ($NEW_VERSION vs $CURRENT_RELEASE_VERSION)!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Execute download script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # å…ˆæ¸…ç†æ—§çš„å›ºä»¶æ–‡ä»¶å¤¹å’Œzipæ–‡ä»¶
          rm -rf "Firmware "* 2>/dev/null || true
          rm -f "Firmware "*.zip 2>/dev/null || true
          
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # æå–æœ€å 6 è¡Œ (åŒ…å« DOWNLOAD COMPLETE å’Œ Hash)
          tail -n 6 firmware_output.txt > changelog_body.txt

      - name: Clean and Re-pack (Fix Size)
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "=== å¼€å§‹æ¸…ç†å’Œé‡æ–°æ‰“åŒ…æµç¨‹ ==="
          
          # 1. æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶å¤¹ï¼ˆPythonè„šæœ¬åˆ›å»ºçš„ï¼‰
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
            echo "::error::æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶å¤¹ï¼"
            echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
            ls -la
            exit 1
          fi
          
          echo "æ‰¾åˆ°å›ºä»¶æ–‡ä»¶å¤¹: $FIRMWARE_FOLDER"
          echo "æ–‡ä»¶å¤¹å¤§å°:"
          du -sh "$FIRMWARE_FOLDER"
          
          # 2. æŸ¥æ‰¾å¹¶åˆ é™¤è„šæœ¬ç”Ÿæˆçš„zipæ–‡ä»¶ï¼ˆè¿™ä¸ªä¼šå¯¼è‡´åŒé‡å‹ç¼©ï¼‰
          echo "=== æŸ¥æ‰¾è„šæœ¬ç”Ÿæˆçš„zipæ–‡ä»¶ ==="
          SCRIPT_ZIP=$(find . -maxdepth 1 -name "Firmware *.zip" | head -n 1)
          
          if [ -n "$SCRIPT_ZIP" ]; then
            echo "åˆ é™¤è„šæœ¬ç”Ÿæˆçš„zipæ–‡ä»¶: $SCRIPT_ZIP"
            rm -f "$SCRIPT_ZIP"
          else
            echo "æœªæ‰¾åˆ°è„šæœ¬ç”Ÿæˆçš„zipæ–‡ä»¶ï¼Œç»§ç»­..."
          fi
          
          # 3. åˆ é™¤æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰zipæ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
          echo "=== æ¸…ç†æ–‡ä»¶å¤¹å†…çš„zipæ–‡ä»¶ ==="
          find "$FIRMWARE_FOLDER" -name "*.zip" -type f -delete
          
          # 4. æ£€æŸ¥æ–‡ä»¶å¤¹å†…å®¹
          echo "=== æ–‡ä»¶å¤¹å†…å®¹æ£€æŸ¥ ==="
          echo "æ–‡ä»¶å¤¹å†…æ–‡ä»¶æ•°é‡:"
          find "$FIRMWARE_FOLDER" -type f | wc -l
          echo "å‰20ä¸ªæ–‡ä»¶:"
          find "$FIRMWARE_FOLDER" -type f | head -20
          
          # 5. è®¡ç®—åŸå§‹æ–‡ä»¶å¤¹å¤§å°
          ORIGINAL_SIZE=$(du -sb "$FIRMWARE_FOLDER" | cut -f1)
          echo "åŸå§‹æ–‡ä»¶å¤¹å¤§å°: $((ORIGINAL_SIZE / 1024 / 1024)) MB"
          
          # 6. åˆ é™¤ä»»ä½•ç°æœ‰çš„Firmware.zip
          echo "=== æ¸…ç†æ—§çš„æ‰“åŒ…æ–‡ä»¶ ==="
          rm -f Firmware.zip 2>/dev/null || true
          
          # 7. é‡æ–°æ‰“åŒ…æ–‡ä»¶å¤¹ï¼ˆç›´æ¥æ‰“åŒ…å†…å®¹ï¼Œä¸åŒ…å«çˆ¶ç›®å½•ï¼‰
          echo "=== å¼€å§‹é‡æ–°æ‰“åŒ… ==="
          cd "$FIRMWARE_FOLDER"
          zip -r -9 -q ../Firmware.zip .
          cd ..
          
          # 8. éªŒè¯æ‰“åŒ…ç»“æœ
          echo "=== éªŒè¯æ‰“åŒ…ç»“æœ ==="
          echo "ç”Ÿæˆçš„Firmware.zipå¤§å°:"
          ls -lh Firmware.zip
          
          echo "ZIPæ–‡ä»¶å†…éƒ¨ç»“æ„:"
          unzip -l Firmware.zip | head -10
          
          ZIP_SIZE=$(stat -c%s "Firmware.zip")
          echo "ZIPæ–‡ä»¶å¤§å°: $((ZIP_SIZE / 1024 / 1024)) MB"
          
          # 9. æ¸…ç†ä¸­é—´æ–‡ä»¶å¤¹ï¼ˆå¯é€‰ï¼‰
          echo "=== æ¸…ç†ä¸­é—´æ–‡ä»¶ ==="
          rm -rf "$FIRMWARE_FOLDER"
          
          echo "=== æ‰“åŒ…å®Œæˆ ==="
          echo "æœ€ç»ˆæ–‡ä»¶: Firmware.zip"
          echo "æœ€ç»ˆå¤§å°: $((ZIP_SIZE / 1024 / 1024)) MB"

      - name: Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const body = fs.readFileSync('changelog_body.txt', 'utf8').trim();
              core.setOutput('release_body', body);
            } catch (error) {
              core.setOutput('release_body', 'No details available.');
            }

      - name: Update Latest Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ${{ steps.version_check.outputs.new_version }}
          body: |
            æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.new_version }}
            è¯¥å›ºä»¶å·²è‡ªåŠ¨ä»ä»»å¤©å ‚å®˜æ–¹æœåŠ¡å™¨ä¸‹è½½ã€æ ¡éªŒå¹¶é‡æ–°æ‰“åŒ…ã€‚
            æ›´æ–°è¯¦æƒ…ï¼š
            ${{ steps.prepare_body.outputs.release_body }}
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
