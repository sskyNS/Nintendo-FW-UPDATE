name: Firmware Auto Downloader (Fixed)

on:
  schedule:
    - cron: '0 * * * *' # 每小时检查一次
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: false
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4
          sudo apt-get update -y && sudo apt-get install -y aria2 bc jq

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update -y && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update -y && sudo apt install gh -y

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool && chmod +x hactool
            sudo mv hactool /usr/local/bin/
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check if required files exist
        id: check_files
        run: |
          echo "Checking for required files..."
          MISSING_FILES=""
          for FILE in certificat.pem prod.keys PRODINFO.bin; do
            [ ! -f "$FILE" ] && MISSING_FILES+=" $FILE"
          done
          [ ! -f "hactool-linux" ] && [ ! -f "$(which hactool 2>/dev/null)" ] && MISSING_FILES+=" hactool"
          if [ -n "$MISSING_FILES" ]; then
            echo "::error::Missing required files:$MISSING_FILES"
            echo "missing_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "All required files found."
            echo "missing_files=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check firmware version
        id: version_check
        if: steps.check_files.outputs.missing_files == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_TITLE=$(curl -s --connect-timeout 10 'https://yls8.mtheall.com/ninupdates/feed.php' | grep -E '<title>Switch [0-9.]+</title>' | grep -v 'Switch 2' | head -n 1)
          [ -z "$LATEST_TITLE" ] && { echo "::error::RSS feed request failed or no data"; exit 1; }
          NEW_VERSION=$(echo "$LATEST_TITLE" | sed -n 's/.*Switch \([0-9.]\+\).*/\1/p')
          [ -z "$NEW_VERSION" ] && { echo "::error::Failed to extract new firmware version"; exit 1; }
          echo "INFO: RSS Latest Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          set +e
          CURRENT_RELEASE_NAME=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          set -e
          CURRENT_VERSION=$(echo "$CURRENT_RELEASE_NAME" | sed -n 's/.*Firmware \([0-9.]\+\).*/\1/p' || echo "0.0.0")
          echo "INFO: Current Release Version: $CURRENT_VERSION"

          UPDATE_NEEDED="false"
          if [ "${{ github.event.inputs.force_update == 'true' }}" = "true" ]; then
            echo "INFO: Manual force update triggered."
            UPDATE_NEEDED="true"
          elif [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
            echo "INFO: New version detected ($NEW_VERSION vs $CURRENT_VERSION)!"
            UPDATE_NEEDED="true"
          else
            echo "INFO: Version match. No update needed."
          fi
          echo "update_needed=$UPDATE_NEEDED" >> "$GITHUB_OUTPUT"

      - name: Execute download script
        id: download_script
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        run: |
          rm -rf "Firmware "* 2>/dev/null
          rm -f "Firmware "*.zip firmware_info.txt firmware_output.txt 2>/dev/null
          echo "Starting Downloader... Current dir: $(pwd)"
          ls -la
          python firmware_downloader.py "${{ steps.version_check.outputs.new_version }}" 2>&1 | tee firmware_output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Python download script failed (exit code: ${PIPESTATUS[0]})"
            tail -100 firmware_output.txt
            exit 1
          fi

      - name: Debug - Check script output
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        run: |
          echo "=== Script Output (last 50 lines) ==="
          tail -50 firmware_output.txt 2>/dev/null || echo "No firmware_output.txt found"
          echo -e "\n=== Current Directory ==="
          ls -la
          echo -e "\n=== Firmware Related Folders ==="
          find . -maxdepth 2 -type d -name "*Firmware*" -o -name "*firmware*" 2>/dev/null | sed 's/^/  /' || echo "No firmware folders found"

      - name: Process firmware files
        id: process_files
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        run: |
          echo "=== Processing Firmware Files ==="
          FIRMWARE_FOLDER=""
          VERSION="${{ steps.version_check.outputs.new_version }}"
          FIRMWARE_FOLDER=$(find . -maxdepth 2 -type d -name "*$VERSION*" | head -n 1)
          [ -z "$FIRMWARE_FOLDER" ] && FIRMWARE_FOLDER=$(find . -maxdepth 2 -type d -name "*[Ff]irmware*" | head -n 1)
          [ -z "$FIRMWARE_FOLDER" ] && { echo "::error::Firmware folder not found!"; find . -maxdepth 2 -type d; exit 1; }
          echo "Found firmware folder: $FIRMWARE_FOLDER"
          ls -la "$FIRMWARE_FOLDER/" || { echo "::error::Cannot list firmware folder"; exit 1; }
          [ -z "$(ls -A "$FIRMWARE_FOLDER" 2>/dev/null)" ] && { echo "::error::Firmware folder is empty!"; exit 1; }
          
          ORIGINAL_SIZE=$(du -sb "$FIRMWARE_FOLDER" | cut -f1)
          rm -f Firmware.zip 2>/dev/null
          zip -r9q Firmware.zip "$FIRMWARE_FOLDER/"
          
          ZIP_SIZE=$(wc -c < Firmware.zip)
          SHA256_HASH=$(sha256sum Firmware.zip | awk '{print $1}')
          echo "original_size=$ORIGINAL_SIZE" >> "$GITHUB_OUTPUT"
          echo "zip_size=$ZIP_SIZE" >> "$GITHUB_OUTPUT"
          echo "sha256_hash=$SHA256_HASH" >> "$GITHUB_OUTPUT"
          rm -rf "$FIRMWARE_FOLDER"

      - name: Prepare release information
        id: prep_release
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        env:
          ZIP_SIZE_BYTES: ${{ steps.process_files.outputs.zip_size }}
          ZIP_SHA256: ${{ steps.process_files.outputs.sha256_hash }}
          NEW_VERSION: ${{ steps.version_check.outputs.new_version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ ! -f "firmware_info.txt" ]; then
            echo "::warning::firmware_info.txt not found, creating fallback"
            cat > firmware_info.txt << EOF
VERSION=${{ steps.version_check.outputs.new_version }}
FILES=0
SIZE_BYTES=0
HASH=unknown
CHANGELOG=Download completed, no changelog provided
SYSTEM_VERSION_FAT=unknown
SYSTEM_VERSION_EXFAT=unknown
EOF
          fi

          get_val() { grep -E "^$1=" firmware_info.txt | cut -d'=' -f2- | sed 's/^[ \t]*//;s/[ \t]*$//' || echo "unknown"; }
          VERSION=$(get_val VERSION)
          FILES=$(get_val FILES)
          SIZE_BYTES=$(get_val SIZE_BYTES)
          HASH=$(get_val HASH)
          CHANGELOG=$(get_val CHANGELOG)
          SYSTEM_VERSION_FAT=$(get_val SYSTEM_VERSION_FAT)
          SYSTEM_VERSION_EXFAT=$(get_val SYSTEM_VERSION_EXFAT)

          SIZE_MB=$(echo "scale=2; if ($SIZE_BYTES == 0) 0 else $SIZE_BYTES / 1024 / 1024" | bc)
          ZIP_MB=$(echo "scale=2; if ($ZIP_SIZE_BYTES == 0) 0 else $ZIP_SIZE_BYTES / 1024 / 1024" | bc)

          PREV_DATA=$(gh release view latest --json body,assets 2>/dev/null || echo '{"body":"<!-- history_downloads: 0 -->","assets":[]}')
          HISTORY_BASE=$(echo "$PREV_DATA" | jq -r '.body | capture("<!-- history_downloads: (?<num>\\d+) -->").num // 0')
          CURRENT_COUNT=$(echo "$PREV_DATA" | jq -r '[.assets[].download_count] | add // 0')
          NEW_TOTAL_DOWNLOADS=$((HISTORY_BASE + CURRENT_COUNT))

          # 重构Release Body写法，彻底解决YAML换行/插值错误
          RELEASE_BODY="## Firmware $VERSION\n\nAutomatic build from official Nintendo servers.\n\n### Build Info\n| Property | Value |\n| :--- | :--- |\n| **File Count** | $FILES |\n| **Raw Size** | $SIZE_MB MB |\n| **Zip Size** | $ZIP_MB MB |\n| **Zip SHA256** | \`$ZIP_SHA256\` |\n\n### Changelog\n> $CHANGELOG\n\n<details>\n<summary>Technical Details (SystemVersion)</summary>\n\n\`\`\`\nFAT32: $SYSTEM_VERSION_FAT\nexFAT: $SYSTEM_VERSION_EXFAT\nContent Hash: $HASH\n\`\`\`\n</details>\n\n<!-- history_downloads: $NEW_TOTAL_DOWNLOADS -->"
          
          # 转义换行并输出到GITHUB_OUTPUT
          echo "release_body=$(echo -e "$RELEASE_BODY" | sed -e 's/\\/\\\\/g' -e 's/\n/\\n/g' -e 's/"/\\"/g')" >> "$GITHUB_OUTPUT"

      - name: Create Release
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "firmware-${{ steps.version_check.outputs.new_version }}"
          name: Firmware ${{ steps.version_check.outputs.new_version }}
          body: ${{ steps.prep_release.outputs.release_body }}
          files: Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
