name: ğŸ® Firmware Auto Downloader (Fixed URL)

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–° (å¿½ç•¥ç‰ˆæœ¬æ£€æŸ¥)'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # âš ï¸ å¿…é¡»æƒé™ï¼šå…è®¸åˆ›å»ºå’Œä¸Šä¼  Release

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ é…ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: âš™ï¸ å®‰è£…ä¾èµ–åº“
        run: |
          pip install requests anynet beautifulsoup4

      - name: â¬‡ï¸ é…ç½® hactool
        run: |
          # æ£€æŸ¥ä»“åº“æ ¹ç›®å½•æ˜¯å¦æœ‰ hactool-linux
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::æœªåœ¨æ ¹ç›®å½•æ‰¾åˆ° hactool-linuxï¼Œè„šæœ¬å¯èƒ½ä¼šå¤±è´¥ï¼"
          fi

      - name: ğŸ” æ£€æŸ¥å›ºä»¶ç‰ˆæœ¬
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. ä» RSS è·å–æœ€æ–°ç‰ˆæœ¬
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::æ— æ³•è®¿é—® RSS æºè·å–ç‰ˆæœ¬ä¿¡æ¯ã€‚"
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: æ£€æµ‹åˆ° RSS æœ€æ–°ç‰ˆæœ¬: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # 2. åˆ¤æ–­æ˜¯å¦æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–°
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
             echo "INFO: æ£€æµ‹åˆ°æ‰‹åŠ¨å¼ºåˆ¶æ›´æ–°æ¨¡å¼ã€‚"
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # 3. è·å– GitHub ä¸Š 'latest' Release çš„ç‰ˆæœ¬ (é˜²æ­¢é¦–æ¬¡è¿è¡ŒæŠ¥é”™)
          set +e 
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e

          # å¦‚æœæ‰¾ä¸åˆ° Releaseï¼Œé»˜è®¤ä¸º 0.0.0
          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: æœªæ‰¾åˆ° 'latest' Releaseï¼Œå¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œã€‚"
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          echo "INFO: å½“å‰ Release ç‰ˆæœ¬: $CURRENT_RELEASE_VERSION"

          # 4. æ¯”å¯¹ç‰ˆæœ¬
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: ç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€æ›´æ–°ã€‚"
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: å‘ç°æ–°ç‰ˆæœ¬ ($NEW_VERSION)ï¼Œå‡†å¤‡æ›´æ–°ï¼"
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: ğŸ’» æ‰§è¡Œä¸‹è½½è„šæœ¬
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "æ­£åœ¨å¯åŠ¨ä¸‹è½½è„šæœ¬..."
          # æ‰§è¡Œè„šæœ¬å¹¶å°†è¾“å‡ºåŒæ—¶æ‰“å°åˆ°å±å¹•å’Œæ–‡ä»¶
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # ç®€å•æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if ! grep -q "Firmware " firmware_output.txt; then
             echo "::warning::è„šæœ¬å·²å®Œæˆï¼Œä½†æ—¥å¿—ä¸­æœªæ£€æµ‹åˆ° 'Firmware' å…³é”®å­—ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å‡ºé”™ã€‚"
          fi

          # æå–æœ€å 5 è¡Œä½œä¸ºæ›´æ–°æ—¥å¿— (åŒ…å« KeyGeneration ç­‰ä¿¡æ¯)
          tail -n 5 firmware_output.txt > changelog_body.txt
          
          # å¦‚æœæ–‡ä»¶ä¸ºç©ºï¼Œå†™å…¥é»˜è®¤æç¤º
          if [ ! -s changelog_body.txt ]; then
            echo "æš‚æ— è¯¦ç»†è§£æå†…å®¹ã€‚" > changelog_body.txt
          fi

      - name: ğŸ“¦ æ¸…ç†å¹¶é‡æ–°æ‰“åŒ… (è§£å†³ä½“ç§¯è¿‡å¤§é—®é¢˜)
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "å¼€å§‹å¤„ç†æ–‡ä»¶æ‰“åŒ…..."
          
          # 1. å¼ºåˆ¶åˆ é™¤ Python è„šæœ¬ç”Ÿæˆçš„ .zip æ–‡ä»¶
          # (Pythonè„šæœ¬ç”Ÿæˆçš„åŒ…å¯èƒ½åŒ…å«é€’å½’å‹ç¼©æˆ–å†—ä½™æ•°æ®ï¼Œå¯¼è‡´ä½“ç§¯å˜æˆ 600MB)
          rm -f *.zip
          
          # 2. å¯»æ‰¾ä¸‹è½½å¥½çš„å›ºä»¶æ–‡ä»¶å¤¹ (é€šå¸¸æ˜¯ä»¥ Firmware å¼€å¤´çš„æ–‡ä»¶å¤¹)
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
            echo "::error::æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶å¤¹ï¼ä¸‹è½½å¯èƒ½å¤±è´¥ã€‚"
            ls -la
            exit 1
          fi
          
          echo "æ‰¾åˆ°å›ºä»¶æ–‡ä»¶å¤¹: $FIRMWARE_FOLDER"
          
          # 3. ä½¿ç”¨ç³»ç»Ÿ zip å‘½ä»¤è¿›è¡Œé«˜å‹ç¼©ç‡æ‰“åŒ…
          # -r é€’å½’, -9 æœ€é«˜å‹ç¼©, -q å®‰é™æ¨¡å¼
          zip -r -9 -q Firmware.zip "$FIRMWARE_FOLDER"
          
          echo "âœ… æ‰“åŒ…å®Œæˆã€‚æ–‡ä»¶å¤§å°å¦‚ä¸‹ï¼š"
          ls -lh Firmware.zip

      - name: ğŸ“ è¯»å–æ—¥å¿—å†…å®¹
        id: prepare_body
        if: steps.version_check.outputs.update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const changelogBody = fs.readFileSync('changelog_body.txt', 'utf8');
              core.setOutput('release_body', changelogBody);
            } catch (error) {
              core.setOutput('release_body', 'æ— è¯¦ç»†æ—¥å¿—ã€‚');
            }

      - name: ğŸš€ å‘å¸ƒä¸­æ–‡ Release (å§‹ç»ˆè¦†ç›– latest)
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Switch å›ºä»¶ ${{ steps.version_check.outputs.new_version }}
          body: |
            ğŸ‰ **æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.new_version }}**
            
            è¯¥å›ºä»¶å·²è‡ªåŠ¨ä»ä»»å¤©å ‚å®˜æ–¹æœåŠ¡å™¨ä¸‹è½½ã€æ ¡éªŒå¹¶é‡æ–°æ‰“åŒ…ã€‚
            
            ---
            
            ğŸ“‹ **è§£æåˆ°çš„æ›´æ–°è¯¦æƒ…ï¼š**
            
            ```text
            ${{ steps.prepare_body.outputs.release_body }}
            ```
            
            ---
            
            â¬‡ï¸ **å›ºå®šä¸‹è½½é“¾æ¥ (å§‹ç»ˆä¸ºæœ€æ–°ç‰ˆ):**
            https://github.com/${{ github.repository }}/releases/download/latest/Firmware.zip
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
