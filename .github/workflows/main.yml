name: Firmware Auto Downloader (Fixed)
on:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update firmware'
        required: false
        default: false
        type: boolean

jobs:
  update_firmware:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install System Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y aria2 bc jq gh
          pip install requests anynet beautifulsoup4

      - name: Setup Hactool
        run: |
          if [ -f "hactool-linux" ]; then
            chmod +x hactool-linux
            sudo mv hactool-linux /usr/local/bin/hactool
          else
            echo "::warning::hactool-linux not found in repo root!"
          fi

      - name: Check Required Files
        id: check_files
        run: |
          MISSING=""
          for f in certificat.pem prod.keys PRODINFO.bin; do
            [ ! -f "$f" ] && MISSING+="$f "
          done
          [ ! -x "$(which hactool 2>/dev/null)" ] && MISSING+="hactool "
          if [ -n "$MISSING" ]; then
            echo "missing_files=true" >> "$GITHUB_OUTPUT"
            echo "::error::Missing required files: $MISSING"
            exit 1
          else
            echo "missing_files=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Get Firmware Versions
        id: get_versions
        if: steps.check_files.outputs.missing_files == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest official version from RSS
          RSS_URL="https://yls8.mtheall.com/ninupdates/feed.php"
          LATEST_VER=$(curl -s --connect-timeout 15 $RSS_URL | grep -E '<title>Switch [0-9.]+</title>' | grep -v 'Switch 2' | head -1 | sed -n 's/.*Switch \([0-9.]\+\).*/\1/p')
          [ -z "$LATEST_VER" ] && { echo "::error::Failed to get latest firmware version"; exit 1; }
          echo "latest_ver=$LATEST_VER" >> "$GITHUB_OUTPUT"

          # Get current release version (fallback to 0.0.0)
          CURRENT_VER=$(gh release view latest --json name --jq '.name' 2>/dev/null | sed -n 's/.*Firmware \([0-9.]\+\).*/\1/p' || echo "0.0.0")
          echo "current_ver=$CURRENT_VER" >> "$GITHUB_OUTPUT"

          # Judge if update is needed
          if [ "${{ github.event.inputs.force_update }}" = "true" ] || [ "$LATEST_VER" != "$CURRENT_VER" ]; then
            echo "need_update=true" >> "$GITHUB_OUTPUT"
          else
            echo "need_update=false" >> "$GITHUB_OUTPUT"
            echo "::info::No update needed, latest version: $LATEST_VER"
          fi

      - name: Clean Old Files
        if: steps.get_versions.outputs.need_update == 'true'
        run: |
          rm -rf Firmware* 2>/dev/null
          rm -f firmware_info.txt firmware_output.txt Firmware.zip 2>/dev/null

      - name: Run Download Script
        if: steps.get_versions.outputs.need_update == 'true'
        id: download
        run: |
          python firmware_downloader.py ${{ steps.get_versions.outputs.latest_ver }} 2>&1 | tee firmware_output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Download script failed!"
            tail -50 firmware_output.txt
            exit 1
          fi

      - name: Locate Firmware Folder
        if: steps.get_versions.outputs.need_update == 'true'
        id: locate_folder
        run: |
          VER=${{ steps.get_versions.outputs.latest_ver }}
          FOLDER=$(find . -maxdepth 2 -type d -name "*$VER*" -o -name "*Firmware*" | head -1)
          [ -z "$FOLDER" ] && { echo "::error::Firmware folder not found!"; exit 1; }
          [ -z "$(ls -A $FOLDER 2>/dev/null)" ] && { echo "::error::Firmware folder is empty!"; exit 1; }
          echo "folder_path=$FOLDER" >> "$GITHUB_OUTPUT"

      - name: Compress Firmware
        if: steps.get_versions.outputs.need_update == 'true'
        id: compress
        run: |
          FOLDER=${{ steps.locate_folder.outputs.folder_path }}
          zip -r9q Firmware.zip $FOLDER/
          ZIP_SIZE=$(wc -c < Firmware.zip)
          SHA256=$(sha256sum Firmware.zip | awk '{print $1}')
          echo "zip_size=$ZIP_SIZE" >> "$GITHUB_OUTPUT"
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          rm -rf $FOLDER

      - name: Prepare Release Metadata
        if: steps.get_versions.outputs.need_update == 'true'
        id: release_meta
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LATEST_VER: ${{ steps.get_versions.outputs.latest_ver }}
          ZIP_SIZE: ${{ steps.compress.outputs.zip_size }}
          SHA256: ${{ steps.compress.outputs.sha256 }}
        run: |
          # Create fallback info if missing
          if [ ! -f "firmware_info.txt" ]; then
            cat > firmware_info.txt << 'EOF'
VERSION=${{ steps.get_versions.outputs.latest_ver }}
FILES=0
SIZE_BYTES=0
HASH=unknown
CHANGELOG=Official Nintendo firmware build
SYSTEM_VERSION_FAT=unknown
SYSTEM_VERSION_EXFAT=unknown
EOF
          fi

          # Read info from file
          get_val() { grep -E "^$1=" firmware_info.txt | cut -d'=' -f2- | sed 's/^ *//;s/ *$//' || echo "unknown"; }
          VER=$(get_val VERSION)
          FILES=$(get_val FILES)
          RAW_SIZE=$(get_val SIZE_BYTES)
          CONTENT_HASH=$(get_val HASH)
          CHANGELOG=$(get_val CHANGELOG)
          SYS_FAT=$(get_val SYSTEM_VERSION_FAT)
          SYS_EXFAT=$(get_val SYSTEM_VERSION_EXFAT)

          # Calculate human-readable size
          RAW_MB=$(echo "scale=2; $RAW_SIZE / 1024 / 1024" | bc || echo "0.00")
          ZIP_MB=$(echo "scale=2; $ZIP_SIZE / 1024 / 1024" | bc || echo "0.00")

          # Download count stats
          PREV_DATA=$(gh release view latest --json body,assets 2>/dev/null || echo '{"body":"<!-- dl:0 -->","assets":[]}')
          PREV_DL=$(echo "$PREV_DATA" | jq -r '.body | capture("<!-- dl:(\\d+) -->").captures[0].string // 0')
          CUR_DL=$(echo "$PREV_DATA" | jq -r '[.assets[].download_count] | add // 0')
          TOTAL_DL=$((PREV_DL + CUR_DL))

          # Build release body (原生单行，无任何转义)
          echo "release_body=## Firmware $VER%0A%0AAutomatic build from official Nintendo servers.%0A%0A### Build Information%0A| Property | Value |%0A| :--- | :--- |%0A| File Count | $FILES |%0A| Raw Size | $RAW_MB MB |%0A| Compressed Size | $ZIP_MB MB |%0A| ZIP SHA256 | \`$SHA256\` |%0A%0A### Changelog%0A> $CHANGELOG%0A%0A<details>%0A<summary>Technical Details</summary>%0A%0A\`\`\`%0AFAT32 System Version: $SYS_FAT%0AexFAT System Version: $SYS_EXFAT%0AContent Hash: $CONTENT_HASH%0A\`\`\`%0A</details>%0A%0A<!-- dl:$TOTAL_DL -->" >> "$GITHUB_OUTPUT"
          echo "release_name=Firmware $VER" >> "$GITHUB_OUTPUT"
          echo "tag_name=firmware-$VER" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        if: steps.get_versions.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag_name }}
          name: ${{ steps.release_meta.outputs.release_name }}
          body: ${{ steps.release_meta.outputs.release_body }}
          files: Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
