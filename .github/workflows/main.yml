name: Firmware Auto Downloader (Fixed)
on:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [main, master]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: false
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
      pull-requests: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          cache: pip

      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4
          sudo apt-get update -y && sudo apt-get install -y aria2 bc jq

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update -y && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          sudo apt update -y && sudo apt install gh -y

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool && chmod +x hactool
            sudo mv hactool /usr/local/bin/
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check required files
        id: check_files
        run: |
          MISSING_FILES=""
          for FILE in certificat.pem prod.keys PRODINFO.bin; do
            [ ! -f "$FILE" ] && MISSING_FILES+=" $FILE"
          done
          [ ! -f "hactool-linux" ] && [ ! -f "$(which hactool 2>/dev/null)" ] && MISSING_FILES+=" hactool"
          if [ -n "$MISSING_FILES" ]; then
            echo "::error::Missing files:$MISSING_FILES"
            echo "missing_files=true" >> "$GITHUB_OUTPUT"
          else
            echo "missing_files=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check firmware version
        id: version_check
        if: steps.check_files.outputs.missing_files == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get latest version from RSS
          LATEST_TITLE=$(curl -s --connect-timeout 10 'https://yls8.mtheall.com/ninupdates/feed.php' | grep -E '<title>Switch [0-9.]+</title>' | grep -v 'Switch 2' | head -n 1)
          [ -z "$LATEST_TITLE" ] && { echo "::error::RSS feed error"; exit 1; }
          NEW_VERSION=$(echo "$LATEST_TITLE" | sed -n 's/.*Switch \([0-9.]\+\).*/\1/p')
          [ -z "$NEW_VERSION" ] && { echo "::error::Extract version failed"; exit 1; }
          echo "new_version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

          # Get current release version
          set +e
          CURRENT_RELEASE_NAME=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          set -e
          CURRENT_VERSION=$(echo "$CURRENT_RELEASE_NAME" | sed -n 's/.*Firmware \([0-9.]\+\).*/\1/p' || echo "0.0.0")

          # Judge update
          UPDATE_NEEDED="false"
          if [ "${{ github.event.inputs.force_update == 'true' }}" = "true" ]; then
            UPDATE_NEEDED="true"
          elif [ "$NEW_VERSION" != "$CURRENT_VERSION" ]; then
            UPDATE_NEEDED="true"
          fi
          echo "update_needed=$UPDATE_NEEDED" >> "$GITHUB_OUTPUT"

      - name: Execute download script
        id: download_script
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        run: |
          rm -rf "Firmware "* 2>/dev/null
          rm -f "Firmware "*.zip firmware_info.txt firmware_output.txt 2>/dev/null
          python firmware_downloader.py "${{ steps.version_check.outputs.new_version }}" 2>&1 | tee firmware_output.txt
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "::error::Script failed"
            tail -100 firmware_output.txt
            exit 1
          fi

      - name: Process firmware files
        id: process_files
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        run: |
          VERSION="${{ steps.version_check.outputs.new_version }}"
          FIRMWARE_FOLDER=$(find . -maxdepth 2 -type d -name "*$VERSION*" | head -n 1)
          [ -z "$FIRMWARE_FOLDER" ] && FIRMWARE_FOLDER=$(find . -maxdepth 2 -type d -name "*[Ff]irmware*" | head -n 1)
          [ -z "$FIRMWARE_FOLDER" ] && { echo "::error::Firmware folder not found"; exit 1; }
          [ -z "$(ls -A "$FIRMWARE_FOLDER" 2>/dev/null)" ] && { echo "::error::Folder empty"; exit 1; }

          # Compress
          rm -f Firmware.zip 2>/dev/null
          zip -r9q Firmware.zip "$FIRMWARE_FOLDER/"
          # Get info
          ZIP_SIZE=$(wc -c < Firmware.zip)
          SHA256_HASH=$(sha256sum Firmware.zip | awk '{print $1}')
          echo "zip_size=$ZIP_SIZE" >> "$GITHUB_OUTPUT"
          echo "sha256_hash=$SHA256_HASH" >> "$GITHUB_OUTPUT"
          # Clean
          rm -rf "$FIRMWARE_FOLDER"

      - name: Prepare release info
        id: prep_release
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        env:
          ZIP_SIZE_BYTES: ${{ steps.process_files.outputs.zip_size }}
          ZIP_SHA256: ${{ steps.process_files.outputs.sha256_hash }}
          NEW_VERSION: ${{ steps.version_check.outputs.new_version }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fallback firmware_info.txt
          if [ ! -f "firmware_info.txt" ]; then
            cat > firmware_info.txt << EOF
VERSION=${{ steps.version_check.outputs.new_version }}
FILES=0
SIZE_BYTES=0
HASH=unknown
CHANGELOG=No changelog
SYSTEM_VERSION_FAT=unknown
SYSTEM_VERSION_EXFAT=unknown
EOF
          fi

          # Read info
          get_val() { grep -E "^$1=" firmware_info.txt | cut -d'=' -f2- | sed 's/^[ \t]*//;s/[ \t]*$//' || echo "unknown"; }
          VERSION=$(get_val VERSION)
          FILES=$(get_val FILES)
          SIZE_BYTES=$(get_val SIZE_BYTES)
          HASH=$(get_val HASH)
          CHANGELOG=$(get_val CHANGELOG)
          SYS_FAT=$(get_val SYSTEM_VERSION_FAT)
          SYS_EXFAT=$(get_val SYSTEM_VERSION_EXFAT)

          # Calculate size
          SIZE_MB=$(echo "scale=2; if ($SIZE_BYTES == 0) 0 else $SIZE_BYTES / 1024 / 1024" | bc)
          ZIP_MB=$(echo "scale=2; if ($ZIP_SIZE_BYTES == 0) 0 else $ZIP_SIZE_BYTES / 1024 / 1024" | bc)

          # Download count
          PREV_DATA=$(gh release view latest --json body,assets 2>/dev/null || echo '{"body":"<!-- history_downloads: 0 -->","assets":[]}')
          HISTORY_BASE=$(echo "$PREV_DATA" | jq -r '.body | capture("<!-- history_downloads: (?<num>\\d+) -->").num // 0')
          CURRENT_COUNT=$(echo "$PREV_DATA" | jq -r '[.assets[].download_count] | add // 0')
          TOTAL=$((HISTORY_BASE + CURRENT_COUNT))

          # Build release body (单行写法，彻底解决YAML换行错误)
          RELEASE_BODY="## Firmware $VERSION\n\nAutomatic build from official Nintendo servers.\n\n### Build Info\n| Property | Value |\n| :--- | :--- |\n| File Count | $FILES |\n| Raw Size | $SIZE_MB MB |\n| Zip Size | $ZIP_MB MB |\n| Zip SHA256 | \`$ZIP_SHA256\` |\n\n### Changelog\n> $CHANGELOG\n\n<details>\n<summary>Technical Details</summary>\n\`\`\`\nFAT32: $SYS_FAT\nexFAT: $SYS_EXFAT\nContent Hash: $HASH\n\`\`\`\n</details>\n\n<!-- history_downloads: $TOTAL -->"
          
          # 关键修复：转义后输出到GITHUB_OUTPUT（L172原错误位置）
          echo "release_body=$(echo -e "$RELEASE_BODY" | sed -e 's/\\/\\\\/g' -e 's/\n/\\n/g' -e 's/"/\\"/g')" >> "$GITHUB_OUTPUT"

      - name: Create Release
        if: steps.version_check.outputs.update_needed == 'true' && steps.check_files.outputs.missing_files == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "firmware-${{ steps.version_check.outputs.new_version }}"
          name: Firmware ${{ steps.version_check.outputs.new_version }}
          body: ${{ steps.prep_release.outputs.release_body }}
          files: Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
