name: ğŸ® Firmware Auto Downloader (Fixed URL)

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update (ignore version check)'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # âš ï¸ å¿…é¡»æƒé™ï¼šå…è®¸åˆ›å»º Release

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: âš™ï¸ Install required Python modules
        run: |
          pip install requests anynet beautifulsoup4

      - name: â¬‡ï¸ Setup hactool-linux
        run: |
          # ç¡®ä¿ä»“åº“é‡Œæœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥é”™
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found in root! Script might fail."
          fi

      - name: ğŸ” Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å– RSS æºä¸­çš„æœ€æ–°ç‰ˆæœ¬
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::Could not retrieve RSS feed."
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: Detected RSS Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # 2. æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶æ›´æ–°
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
             echo "INFO: Manual force update triggered."
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # 3. å®‰å…¨è·å–å½“å‰ Latest Release ç‰ˆæœ¬ (ä¿®å¤é¦–æ¬¡è¿è¡ŒæŠ¥é”™çš„é—®é¢˜)
          set +e # æš‚æ—¶å…è®¸é”™è¯¯ï¼Œé˜²æ­¢ gh å‘½ä»¤å¤±è´¥å¯¼è‡´è„šæœ¬é€€å‡º
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e # æ¢å¤é”™è¯¯æ£€æŸ¥

          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: No 'latest' release found. First run?"
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          echo "INFO: Current Release Version: $CURRENT_RELEASE_VERSION"

          # 4. æ¯”å¯¹ç‰ˆæœ¬
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: Version match. No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: New version found! Update needed."
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: ğŸ’» Execute download script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "Starting download script..."
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸçš„ä¸‹è½½äº†
          if ! grep -q "Firmware " firmware_output.txt; then
             echo "::warning::Script finished but output looks suspicious. Check logs."
          fi

          # æŠ“å–æ›´æ–°æ—¥å¿— (å¦‚æœæ²¡æœ‰æ—¥å¿—åˆ™å†™å…¥é»˜è®¤å€¼)
          tail -n 4 firmware_output.txt > changelog_body.txt
          if [ ! -s changelog_body.txt ]; then
            echo "No changelog details available." > changelog_body.txt
          fi

      - name: ğŸ”„ Rename file for Fixed URL
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # æŸ¥æ‰¾ä¸‹è½½çš„ zip æ–‡ä»¶
          DOWNLOADED_FILE=$(find . -maxdepth 1 -name "Firmware *.zip" | head -n 1)
          
          if [ -f "$DOWNLOADED_FILE" ]; then
            echo "Renaming '$DOWNLOADED_FILE' to 'Firmware.zip'..."
            mv "$DOWNLOADED_FILE" Firmware.zip
          else
            echo "::error::Download failed! No zip file found matching pattern 'Firmware *.zip'."
            ls -la # åˆ—å‡ºå½“å‰æ–‡ä»¶ä»¥ä¾¿è°ƒè¯•
            exit 1
          fi

      - name: ğŸ“ Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const changelogBody = fs.readFileSync('changelog_body.txt', 'utf8');
              core.setOutput('release_body', changelogBody);
            } catch (error) {
              core.setOutput('release_body', 'No details available.');
            }

      - name: ğŸš€ Update "Latest" Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ${{ steps.version_check.outputs.new_version }}
          body: |
            **Latest Firmware Version: ${{ steps.version_check.outputs.new_version }}**
            
            Automatic download from official source.
            
            ---
            **Changelog:**
            ${{ steps.prepare_body.outputs.release_body }}
            
            ---
            â¬‡ï¸ **Fixed Download Link:**
            https://github.com/${{ github.repository }}/releases/download/latest/Firmware.zip
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
