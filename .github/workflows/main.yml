name: ğŸ® Firmware Auto Downloader (Fixed URL)

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # å¿…é¡»æƒé™ï¼šå…è®¸ä¿®æ”¹ Release

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: âš™ï¸ Install required Python modules
        run: |
          pip install requests anynet beautifulsoup4

      - name: â¬‡ï¸ Setup hactool-linux
        run: |
          cp hactool-linux hactool
          chmod +x hactool
          
      - name: ğŸ” Check firmware version (Compare with Latest Release)
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å– RSS æºä¸­çš„æœ€æ–°ç‰ˆæœ¬
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::Could not retrieve the firmware title for Switch 1 from the RSS feed."
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: Detected RSS Version: $NEW_VERSION"

          # 2. è·å–å½“å‰ GitHub 'latest' Release çš„åå­— (å‡è®¾åå­—å°±æ˜¯ç‰ˆæœ¬å·)
          # å¦‚æœæ²¡æœ‰ Releaseï¼Œé»˜è®¤ä¸º 0.0.0
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null || echo "0.0.0")
          echo "INFO: Current Release Version: $CURRENT_RELEASE_VERSION"

          # 3. æ¯”å¯¹ç‰ˆæœ¬
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: Version match. No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: New version found! Update needed ($CURRENT_RELEASE_VERSION -> $NEW_VERSION)."
            echo "update_needed=true" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: ğŸ’» Execute download script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # è¿è¡Œä¸‹è½½è„šæœ¬
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # æŠ“å–æ›´æ–°æ—¥å¿—
          tail -n 4 firmware_output.txt > changelog_body.txt

      - name: ğŸ”„ Rename file for Fixed URL
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # æ‰¾åˆ°ä¸‹è½½ç”Ÿæˆçš„ zip æ–‡ä»¶ (é€šå¸¸åŒ…å«ç‰ˆæœ¬å·)
          DOWNLOADED_FILE=$(find . -maxdepth 1 -name "Firmware *.zip" | head -n 1)
          
          if [ -f "$DOWNLOADED_FILE" ]; then
            echo "Renaming $DOWNLOADED_FILE to Firmware.zip..."
            # é‡å‘½åä¸ºå›ºå®šæ–‡ä»¶å
            mv "$DOWNLOADED_FILE" Firmware.zip
          else
            echo "::error::Downloaded file not found!"
            exit 1
          fi

      - name: ğŸ“ Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changelogBody = fs.readFileSync('changelog_body.txt', 'utf8');
            core.setOutput('release_body', changelogBody);

      - name: ğŸš€ Update "Latest" Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest           # æ°¸è¿œä½¿ç”¨ 'latest' è¿™ä¸ªæ ‡ç­¾
          name: ${{ steps.version_check.outputs.new_version }} # Release æ ‡é¢˜æ˜¾ç¤ºå…·ä½“ç‰ˆæœ¬å·ï¼Œæ–¹ä¾¿æ£€æµ‹é€»è¾‘
          body: |
            **Latest Firmware Version: ${{ steps.version_check.outputs.new_version }}**
            
            Automatic download from official source.
            
            ---
            **Changelog:**
            ${{ steps.prepare_body.outputs.release_body }}
            
            ---
            â¬‡ï¸ **Fixed Download Link:**
            https://github.com/${{ github.repository }}/releases/download/latest/Firmware.zip
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
