name: ğŸ® Firmware Auto Downloader (Fixed URL)

on:
  # 1. æ¯å¤©æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  schedule:
    - cron: '0 * * * *'
  
  # 2. å½“ä»£ç æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ (å¿½ç•¥æ–‡æ¡£ä¿®æ”¹)
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'

  # 3. å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®å¼ºåˆ¶è¿è¡Œ
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # âš ï¸ è¯»å†™æƒé™ç”¨äºå‘å¸ƒ Release

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # --- 1. è·å– RSS æœ€æ–°ç‰ˆæœ¬ ---
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::RSS feed error"
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: RSS Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # --- 2. å¼ºåˆ¶æ›´æ–°é€»è¾‘ (æ‰‹åŠ¨ æˆ– ä»£ç æ¨é€) ---
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ä¸”å‹¾é€‰äº†Forceï¼Œæˆ–è€…æ˜¯ä»£ç Pushè§¦å‘ï¼Œåˆ™å¼ºåˆ¶æ›´æ–°
          if [ "${{ github.event.inputs.force_update }}" == "true" ] || [ "${{ github.event_name }}" == "push" ]; then
             echo "INFO: Triggered by Manual Force or Code Push. Skipping version check."
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # --- 3. è·å–å½“å‰ Release ç‰ˆæœ¬ (å®šæ—¶ä»»åŠ¡é€»è¾‘) ---
          set +e 
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          # --- 4. æ¯”å¯¹ç‰ˆæœ¬ ---
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: Version match ($NEW_VERSION). No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: New version found ($NEW_VERSION vs $CURRENT_RELEASE_VERSION)!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Execute download script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # æå–æœ€å 6 è¡Œ (åŒ…å« DOWNLOAD COMPLETE å’Œ Hash)
          tail -n 6 firmware_output.txt > changelog_body.txt

      - name: Clean and Re-pack (Fix Size)
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "Starting cleanup and re-pack process..."
          
          # 1. æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶å¤¹
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
            echo "::error::Firmware folder not found!"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "Found firmware folder: $FIRMWARE_FOLDER"
          echo "Folder contents before cleanup:"
          ls -la "$FIRMWARE_FOLDER/" | head -20
          
          # 2. æ¸…ç†æ–‡ä»¶å¤¹å†…çš„æ‰€æœ‰zipæ–‡ä»¶
          echo "Cleaning zip files inside firmware folder..."
          find "$FIRMWARE_FOLDER" -name "*.zip" -type f -delete
          
          # 3. æ£€æŸ¥æ–‡ä»¶å¤¹æ˜¯å¦ä¸ºç©º
          if [ -z "$(ls -A "$FIRMWARE_FOLDER")" ]; then
            echo "::error::Firmware folder is empty after cleanup!"
            exit 1
          fi
          
          echo "Folder contents after cleanup:"
          ls -la "$FIRMWARE_FOLDER/" | head -20
          
          # 4. åˆ é™¤æ‰€æœ‰å…¶ä»–zipæ–‡ä»¶ï¼ˆåŒ…æ‹¬æ ¹ç›®å½•çš„ï¼‰
          echo "Cleaning all other zip files..."
          find . -maxdepth 1 -name "*.zip" -type f -delete
          
          # 5. ç›´æ¥è¿›å…¥æ–‡ä»¶å¤¹æ‰“åŒ…ï¼Œé¿å…åŒ…å«çˆ¶è·¯å¾„
          echo "Packing files from: $FIRMWARE_FOLDER"
          (cd "$FIRMWARE_FOLDER" && zip -r -9 -q ../Firmware.zip .)
          
          # 6. éªŒè¯æ‰“åŒ…ç»“æœ
          echo "Final Firmware.zip details:"
          ls -lh Firmware.zip
          
          echo "Number of files in zip:"
          unzip -l Firmware.zip | wc -l
          
          echo "First 10 files in zip:"
          unzip -l Firmware.zip | head -15

      - name: Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const body = fs.readFileSync('changelog_body.txt', 'utf8').trim();
              core.setOutput('release_body', body);
            } catch (error) {
              core.setOutput('release_body', 'No details available.');
            }

      - name: Update Latest Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ${{ steps.version_check.outputs.new_version }}
          body: |
            æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.new_version }}
            è¯¥å›ºä»¶å·²è‡ªåŠ¨ä»ä»»å¤©å ‚å®˜æ–¹æœåŠ¡å™¨ä¸‹è½½ã€æ ¡éªŒå¹¶é‡æ–°æ‰“åŒ…ã€‚
            æ›´æ–°è¯¦æƒ…ï¼š
            ${{ steps.prepare_body.outputs.release_body }}
            æ³¨æ„ï¼šæ­¤å›ºä»¶åŒ…ä»…åŒ…å«åŸå§‹å›ºä»¶æ–‡ä»¶ï¼Œæ— ä»»ä½•é¢å¤–å‹ç¼©å±‚ã€‚
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
