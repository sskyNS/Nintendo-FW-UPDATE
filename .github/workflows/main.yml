name: ğŸ® Firmware Auto Downloader (Fixed)

on:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4
          sudo apt-get update
          sudo apt-get install -y aria2

      - name: Install GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å– RSS æœ€æ–°ç‰ˆæœ¬
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::RSS feed error"
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: RSS Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # å¼ºåˆ¶æ›´æ–°é€»è¾‘
          if [ "${{ github.event.inputs.force_update }}" == "true" ] || [ "${{ github.event_name }}" == "push" ]; then
             echo "INFO: Triggered by Manual Force or Code Push. Skipping version check."
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # è·å–å½“å‰ Release ç‰ˆæœ¬
          set +e 
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          # æ¯”å¯¹ç‰ˆæœ¬
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: Version match ($NEW_VERSION). No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: New version found ($NEW_VERSION vs $CURRENT_RELEASE_VERSION)!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Execute download script
        id: download_script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -rf "Firmware "* 2>/dev/null || true
          rm -f "Firmware "*.zip 2>/dev/null || true
          rm -f firmware_info.txt firmware_output.txt firmware_info_step.txt 2>/dev/null || true
          
          # æ‰§è¡Œä¸‹è½½è„šæœ¬
          echo "å¼€å§‹ä¸‹è½½å›ºä»¶..."
          # å‡è®¾è„šæœ¬åä¸º firmware_downloader.py
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # ä¿å­˜å›ºä»¶ä¿¡æ¯ (æå–è„šæœ¬è¾“å‡ºå†…å®¹ç”¨äºChangelog)
          # è¿™é‡Œå‡è®¾ä½ çš„ Python è„šæœ¬æœ€åè¾“å‡ºäº†ç›¸å…³ä¿¡æ¯
          # ç®€å•çš„ grep æå–æ–¹å¼ï¼Œé˜²æ­¢å›  Python è„šæœ¬è¾“å‡ºæ ¼å¼å˜åŒ–å¯¼è‡´å¤±è´¥
          if [ -f firmware_output.txt ]; then
             grep "SystemVersion" firmware_output.txt > firmware_info_parsed.txt || true
          fi

      - name: Process firmware files
        id: process_files
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "=== å¤„ç†å›ºä»¶æ–‡ä»¶ ==="
          
          # 1. æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶å¤¹
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
            echo "::error::æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶å¤¹ï¼"
            ls -la
            exit 1
          fi
          
          echo "æ‰¾åˆ°æ–‡ä»¶å¤¹: $FIRMWARE_FOLDER"
          
          # 2. åˆ é™¤ Python è„šæœ¬å¯èƒ½ç”Ÿæˆçš„ zip (é˜²æ­¢åµŒå¥—å‹ç¼©å¯¼è‡´åŒå€å¤§å°)
          rm -f "$FIRMWARE_FOLDER.zip" 2>/dev/null || true
          rm -f Firmware.zip 2>/dev/null || true
          
          # 3. è®¡ç®—åŸå§‹å¤§å°
          ORIGINAL_SIZE=$(du -sb "$FIRMWARE_FOLDER" | cut -f1)
          echo "original_size=$ORIGINAL_SIZE" >> $GITHUB_OUTPUT
          
          # 4. é‡æ–°æ‰“åŒ…ï¼ˆå•å±‚å‹ç¼© - å…³é”®æ­¥éª¤ï¼‰
          # è¿›å…¥ç›®å½•å†å‹ç¼©ï¼Œç¡®ä¿ Zip æ ¹ç›®å½•ä¸‹ç›´æ¥æ˜¯æ–‡ä»¶ï¼Œè€Œä¸æ˜¯æ–‡ä»¶å¤¹
          echo "æ­£åœ¨æ‰“åŒ…..."
          (cd "$FIRMWARE_FOLDER" && zip -r -9 -q ../Firmware.zip .)
          
          # 5. è®¡ç®— Zip å¤§å°
          ZIP_SIZE=$(stat -c%s "Firmware.zip")
          echo "zip_size=$ZIP_SIZE" >> $GITHUB_OUTPUT
          
          # 6. è®¡ç®— SHA256
          SHA256_HASH=$(sha256sum Firmware.zip | cut -d' ' -f1)
          echo "sha256_hash=$SHA256_HASH" >> $GITHUB_OUTPUT
          
          # 7. æ¸…ç†
          rm -rf "$FIRMWARE_FOLDER"

      - name: Prepare release information
        id: prep_release
        if: steps.version_check.outputs.update_needed == 'true'
        env:
          ZIP_SIZE: ${{ steps.process_files.outputs.zip_size }}
          SHA256_HASH: ${{ steps.process_files.outputs.sha256_hash }}
          ORIGINAL_SIZE: ${{ steps.process_files.outputs.original_size }}
          NEW_VERSION: ${{ steps.version_check.outputs.new_version }}
        run: |
          # è®¡ç®— MB å¤§å°
          FIRMWARE_SIZE_MB=$((ORIGINAL_SIZE / 1024 / 1024))
          ZIP_SIZE_MB=$((ZIP_SIZE / 1024 / 1024))
          
          # è·å– Changelog å†…å®¹ (å– firmware_output.txt æœ€å 15 è¡Œ)
          CHANGELOG_CONTENT=$(tail -n 15 firmware_output.txt)

          # ç›´æ¥æ„å»º GITHUB_OUTPUTï¼Œé¿å…åœ¨ Shell ä¸­å®šä¹‰å·¨å‹å˜é‡å¯¼è‡´ YAML è§£æé”™è¯¯
          {
            echo "release_body<<EOF"
            echo "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š${NEW_VERSION}"
            echo ""
            echo "è¯¥å›ºä»¶å·²è‡ªåŠ¨ä»ä»»å¤©å ‚å®˜æ–¹æœåŠ¡å™¨ä¸‹è½½ã€æ ¡éªŒå¹¶é‡æ–°æ‰“åŒ…ã€‚"
            echo ""
            echo "ğŸ“Š å›ºä»¶ä¿¡æ¯ï¼š"
            echo "- åŸå§‹å¤§å°: ${FIRMWARE_SIZE_MB} MB"
            echo "- æ‰“åŒ…å¤§å°: ${ZIP_SIZE_MB} MB"
            echo "- å‘å¸ƒåŒ…SHA256: ${SHA256_HASH}"
            echo ""
            echo "ğŸ“ è¯¦ç»†æ—¥å¿—ï¼š"
            echo "${CHANGELOG_CONTENT}"
            echo ""
            echo "ğŸ”§ æŠ€æœ¯è¯´æ˜ï¼šæ­¤å›ºä»¶åŒ…ä¸ºåŸå§‹å›ºä»¶æ–‡ä»¶çš„å•å±‚æ‰“åŒ…ï¼ˆZipæ ¹ç›®å½•å³ä¸ºncaæ–‡ä»¶ï¼‰ï¼Œç¡®ä¿ä¸ºåŸå§‹å¤§å°ã€‚"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Firmware ${{ steps.version_check.outputs.new_version }}
          body: ${{ steps.prep_release.outputs.release_body }}
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
