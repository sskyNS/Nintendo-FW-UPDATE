name: Firmware Auto Downloader

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update check'
        required: false
        default: false
        type: boolean

jobs:
  download_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: â¬‡ï¸ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: âš™ï¸ Install dependencies
        run: |
          pip install requests anynet beautifulsoup4
          sudo apt-get update
          sudo apt-get install -y aria2

      - name: ðŸ”‘ Restore critical keys
        env:
          PROD_KEYS: ${{ secrets.PROD_KEYS }}
          CERT_PEM: ${{ secrets.CERT_PEM }}
          PRODINFO_BIN: ${{ secrets.PRODINFO_BIN }}
        run: |
          echo "$PROD_KEYS" > prod.keys
          echo "$CERT_PEM" > certificat.pem
          echo "$PRODINFO_BIN" | base64 -d > PRODINFO.bin
          
          if [ ! -s prod.keys ] || [ ! -s certificat.pem ]; then
             echo "::error::Secrets are missing!"
             exit 1
          fi

      - name: ðŸ› ï¸ Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found."
          fi
          
      # å³ä½¿æˆ‘ä»¬ä¸‹è½½æ—¶ä¸ä¾èµ– RSSï¼Œæˆ‘ä»¬ä»ç„¶ç”¨å®ƒæ¥åˆ¤æ–­æ˜¯å¦â€œéœ€è¦â€è¿è¡Œï¼Œä»¥èŠ‚çœèµ„æº
      - name: ðŸ” Check trigger
        id: check
        run: |
          # ä»…ç”¨äºŽè§¦å‘ï¼Œä¸ä¼ ç»™ä¸‹è½½è„šæœ¬
          if [ "${{ inputs.force_update }}" == "true" ]; then
             echo "run_download=true" >> $GITHUB_OUTPUT
          else
             echo "run_download=true" >> $GITHUB_OUTPUT
             # æ³¨æ„ï¼šä¸ºäº†ä¿®å¤ä½ çš„é—®é¢˜ï¼Œæˆ‘æš‚æ—¶å¼ºåˆ¶å¼€å¯ä¸‹è½½ï¼Œè®© Python è„šæœ¬åŽ»å†³å®šåˆ°åº•ä¸‹å“ªä¸ªç‰ˆæœ¬
             # åªè¦ Python è„šæœ¬å‘çŽ°æœ€æ–°ç‰ˆå·²å­˜åœ¨ï¼Œå®ƒä¼šè¦†ç›–æˆ–é‡æ–°ä¸‹è½½ï¼ˆå–å†³äºŽé€»è¾‘ï¼‰ï¼Œä½†è¿™é‡Œæœ€ç¨³å¦¥ã€‚
          fi

      - name: ðŸ’» Execute download script (Auto-Discovery)
        id: download
        if: steps.check.outputs.run_download == 'true'
        shell: bash
        run: |
          set -o pipefail
          # === å…³é”®ä¿®å¤ï¼šä¸ä¼ å‚æ•°ï¼Œå¯ç”¨è‡ªåŠ¨æŽ¢æµ‹æ¨¡å¼ ===
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # ä»Žæ—¥å¿—æå–çœŸæ­£çš„ç‰ˆæœ¬å·
          FIRMWARE_FOLDER=$(grep 'Folder: Firmware ' firmware_output.txt | tail -n 1 | awk -F'Firmware ' '{print $NF}' | tr -d '\r')
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
             echo "::error::Could not determine downloaded version from logs."
             exit 1
          fi
          
          echo "firmware_version=$FIRMWARE_FOLDER" >> $GITHUB_OUTPUT

      - name: ðŸ“¦ Check if Tag Exists
        id: tag_check
        run: |
          VERSION="${{ steps.download.outputs.firmware_version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "::warning::Tag $VERSION already exists. Skipping release."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Create Release
        if: steps.download.outputs.firmware_version != '' && steps.tag_check.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.download.outputs.firmware_version }}
          name: Firmware ${{ steps.download.outputs.firmware_version }}
          body: |
            Automatic download from Nintendo CDN.
            Detected Version: **${{ steps.download.outputs.firmware_version }}**
          files: |
            Firmware ${{ steps.download.outputs.firmware_version }}.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
