name: ğŸ® Firmware Auto Downloader (Fixed)

on:
  schedule:
    - cron: '0 * * * *'
  push:
    branches: [ "main", "master" ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4
          sudo apt-get update
          sudo apt-get install -y aria2

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å– RSS æœ€æ–°ç‰ˆæœ¬
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::RSS feed error"
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: RSS Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # å¼ºåˆ¶æ›´æ–°é€»è¾‘
          if [ "${{ github.event.inputs.force_update }}" == "true" ] || [ "${{ github.event_name }}" == "push" ]; then
             echo "INFO: Triggered by Manual Force or Code Push. Skipping version check."
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # è·å–å½“å‰ Release ç‰ˆæœ¬
          set +e 
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          # æ¯”å¯¹ç‰ˆæœ¬
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "INFO: Version match ($NEW_VERSION). No update needed."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "INFO: New version found ($NEW_VERSION vs $CURRENT_RELEASE_VERSION)!"
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Execute download script
        id: download_script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # æ¸…ç†æ—§æ–‡ä»¶
          rm -rf "Firmware "* 2>/dev/null || true
          rm -f "Firmware "*.zip 2>/dev/null || true
          rm -f firmware_info.txt firmware_output.txt firmware_info_step.txt 2>/dev/null || true
          
          # æ‰§è¡Œä¸‹è½½è„šæœ¬
          echo "å¼€å§‹ä¸‹è½½å›ºä»¶..."
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # æå–æœ€å15è¡Œï¼ˆåŒ…å«æ‰€æœ‰å…³é”®ä¿¡æ¯ï¼‰
          echo "æå–æ—¥å¿—ä¿¡æ¯..."
          tail -n 15 firmware_output.txt > changelog_body.txt
          
          # ä¿å­˜å›ºä»¶ä¿¡æ¯
          if [ -f firmware_info.txt ]; then
            cp firmware_info.txt firmware_info_step.txt
            echo "å·²ä¿å­˜å›ºä»¶ä¿¡æ¯åˆ° firmware_info_step.txt"
          else
            echo "è­¦å‘Š: firmware_info.txt æœªç”Ÿæˆ"
          fi

      - name: Process firmware files
        id: process_files
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          echo "=== å¤„ç†å›ºä»¶æ–‡ä»¶ ==="
          
          # 1. æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶å¤¹
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
            echo "::error::æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶å¤¹ï¼"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          echo "æ‰¾åˆ°æ–‡ä»¶å¤¹: $FIRMWARE_FOLDER"
          
          # 2. åˆ é™¤è„šæœ¬å¯èƒ½ç”Ÿæˆçš„zipæ–‡ä»¶ï¼ˆé˜²æ­¢åŒé‡å‹ç¼©ï¼‰
          rm -f "$FIRMWARE_FOLDER.zip" 2>/dev/null || true
          rm -f Firmware.zip 2>/dev/null || true
          
          # 3. æ£€æŸ¥æ–‡ä»¶å¤¹å†…å®¹
          echo "æ–‡ä»¶å¤¹å¤§å°:"
          du -sh "$FIRMWARE_FOLDER"
          echo "æ–‡ä»¶æ•°é‡:"
          find "$FIRMWARE_FOLDER" -type f | wc -l
          
          # 4. è®¡ç®—åŸå§‹å¤§å°
          ORIGINAL_SIZE=$(du -sb "$FIRMWARE_FOLDER" | cut -f1)
          ORIGINAL_SIZE_MB=$((ORIGINAL_SIZE / 1024 / 1024))
          echo "åŸå§‹å¤§å°: ${ORIGINAL_SIZE_MB} MB"
          echo "original_size=$ORIGINAL_SIZE" >> $GITHUB_OUTPUT
          
          # 5. é‡æ–°æ‰“åŒ…ï¼ˆå•å±‚å‹ç¼©ï¼‰
          echo "æ­£åœ¨æ‰“åŒ…..."
          (cd "$FIRMWARE_FOLDER" && zip -r -9 -q ../Firmware.zip .)
          
          # 6. éªŒè¯ç»“æœ
          echo "æ‰“åŒ…ç»“æœ:"
          ls -lh Firmware.zip
          
          ZIP_SIZE=$(stat -c%s "Firmware.zip")
          ZIP_SIZE_MB=$((ZIP_SIZE / 1024 / 1024))
          echo "ZIPå¤§å°: ${ZIP_SIZE_MB} MB"
          echo "zip_size=$ZIP_SIZE" >> $GITHUB_OUTPUT
          
          # 7. è®¡ç®—å“ˆå¸Œ
          echo "è®¡ç®—SHA256..."
          SHA256_HASH=$(sha256sum Firmware.zip | cut -d' ' -f1)
          echo "SHA256: $SHA256_HASH"
          echo "sha256_hash=$SHA256_HASH" >> $GITHUB_OUTPUT
          
          # 8. æ¸…ç†ä¸­é—´æ–‡ä»¶
          echo "æ¸…ç†ä¸­é—´æ–‡ä»¶å¤¹..."
          rm -rf "$FIRMWARE_FOLDER"
          
          echo "=== å¤„ç†å®Œæˆ ==="
          echo "åŸå§‹å¤§å°: ${ORIGINAL_SIZE_MB} MB, æ‰“åŒ…å: ${ZIP_SIZE_MB} MB"

      - name: Prepare release information
        id: prep_release
        if: steps.version_check.outputs.update_needed == 'true'
        env:
          ZIP_SIZE: ${{ steps.process_files.outputs.zip_size }}
          SHA256_HASH: ${{ steps.process_files.outputs.sha256_hash }}
          ORIGINAL_SIZE: ${{ steps.process_files.outputs.original_size }}
        run: |
          echo "=== å‡†å¤‡å‘å¸ƒä¿¡æ¯ ==="
          
          # è¯»å–å›ºä»¶ä¿¡æ¯
          if [ -f firmware_info_step.txt ]; then
            echo "ä½¿ç”¨ firmware_info_step.txt"
            FIRMWARE_SIZE=$(grep 'Size:' firmware_info_step.txt | cut -d' ' -f2)
            FIRMWARE_FILES=$(grep 'Files:' firmware_info_step.txt | cut -d' ' -f2)
            TOTAL_HASH=$(grep 'Total Hash:' firmware_info_step.txt | cut -d' ' -f3)
            CHANGELOG=$(grep -A 1 'Changelog:' firmware_info_step.txt | tail -n 1 || echo "No changelog available")
          elif [ -f firmware_info.txt ]; then
            echo "ä½¿ç”¨ firmware_info.txt"
            FIRMWARE_SIZE=$(grep 'Size:' firmware_info.txt | cut -d' ' -f2)
            FIRMWARE_FILES=$(grep 'Files:' firmware_info.txt | cut -d' ' -f2)
            TOTAL_HASH=$(grep 'Total Hash:' firmware_info.txt | cut -d' ' -f3)
            CHANGELOG=$(grep -A 1 'Changelog:' firmware_info.txt | tail -n 1 || echo "No changelog available")
          else
            echo "ä½¿ç”¨é»˜è®¤å€¼"
            FIRMWARE_SIZE="$ORIGINAL_SIZE"
            FIRMWARE_FILES="Unknown"
            TOTAL_HASH="$SHA256_HASH"
            if [ -f changelog_body.txt ]; then
              CHANGELOG=$(tail -n 5 changelog_body.txt)
            else
              CHANGELOG="No changelog available"
            fi
          fi
          
          # è®¡ç®—MBå¤§å°
          if [[ "$FIRMWARE_SIZE" =~ ^[0-9]+$ ]]; then
            FIRMWARE_SIZE_MB=$((FIRMWARE_SIZE / 1024 / 1024))
          else
            FIRMWARE_SIZE_MB="Unknown"
          fi
          
          if [[ "$ZIP_SIZE" =~ ^[0-9]+$ ]]; then
            ZIP_SIZE_MB=$((ZIP_SIZE / 1024 / 1024))
          else
            ZIP_SIZE_MB="Unknown"
          fi
          
          # æ ¼å¼åŒ–å‘å¸ƒå†…å®¹
          RELEASE_BODY="æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.new_version }}
          
è¯¥å›ºä»¶å·²è‡ªåŠ¨ä»ä»»å¤©å ‚å®˜æ–¹æœåŠ¡å™¨ä¸‹è½½ã€æ ¡éªŒå¹¶é‡æ–°æ‰“åŒ…ã€‚

ğŸ“Š å›ºä»¶ä¿¡æ¯ï¼š
- æ–‡ä»¶æ•°é‡: $FIRMWARE_FILES
- åŸå§‹å¤§å°: ${FIRMWARE_SIZE_MB} MB
- æ‰“åŒ…å¤§å°: ${ZIP_SIZE_MB} MB
- å®Œæ•´æ€§æ ¡éªŒ: ${TOTAL_HASH}
- å‘å¸ƒåŒ…SHA256: ${SHA256_HASH}

ğŸ“ æ›´æ–°è¯¦æƒ…ï¼š
${CHANGELOG}

ğŸ”§ æŠ€æœ¯è¯´æ˜ï¼šæ­¤å›ºä»¶åŒ…ä¸ºåŸå§‹å›ºä»¶æ–‡ä»¶çš„å•å±‚æ‰“åŒ…ï¼Œç¡®ä¿ä¸ºåŸå§‹å¤§å°ã€‚"
          
          echo 'release_body<<EOF' >> $GITHUB_OUTPUT
          echo "$RELEASE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "å‘å¸ƒä¿¡æ¯å‡†å¤‡å®Œæˆ"

      - name: Create Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Firmware ${{ steps.version_check.outputs.new_version }}
          body: ${{ steps.prep_release.outputs.release_body }}
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
