name: ğŸ® Firmware Auto Downloader (Fixed URL)

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_update:
        description: 'Force update'
        required: false
        default: true
        type: boolean

jobs:
  update_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # âš ï¸ å¿…é¡»æƒé™

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests anynet beautifulsoup4

      - name: Setup hactool
        run: |
          if [ -f "hactool-linux" ]; then
            cp hactool-linux hactool
            chmod +x hactool
          else
            echo "::warning::hactool-linux not found"
          fi

      - name: Check firmware version
        id: version_check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å– RSS æœ€æ–°ç‰ˆæœ¬
          LATEST_TITLE=$(curl -s 'https://yls8.mtheall.com/ninupdates/feed.php' | \
                         grep '<title>Switch ' | \
                         grep -v '<title>Switch 2 ' | \
                         head -n 1)

          if [ -z "$LATEST_TITLE" ]; then
            echo "::error::RSS feed error"
            exit 1 
          fi

          NEW_VERSION=$(echo "$LATEST_TITLE" | grep -oP 'Switch \K[0-9.]+')
          echo "INFO: RSS Version: $NEW_VERSION"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # 2. å¼ºåˆ¶æ›´æ–°æ£€æŸ¥
          if [ "${{ github.event.inputs.force_update }}" == "true" ]; then
             echo "INFO: Force update triggered"
             echo "update_needed=true" >> $GITHUB_OUTPUT
             exit 0
          fi

          # 3. è·å–å½“å‰ Release ç‰ˆæœ¬
          set +e 
          CURRENT_RELEASE_VERSION=$(gh release view latest --json name --jq '.name' 2>/dev/null)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -ne 0 ] || [ -z "$CURRENT_RELEASE_VERSION" ]; then
            CURRENT_RELEASE_VERSION="0.0.0"
          fi
          
          # 4. æ¯”å¯¹
          if [ "$NEW_VERSION" == "$CURRENT_RELEASE_VERSION" ]; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Execute download script
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          python3 firmware_downloader.py | tee firmware_output.txt
          
          # æå–æœ€å 6 è¡Œ (ç¡®ä¿åŒ…å« DOWNLOAD COMPLETE! å’Œå“ˆå¸Œå€¼)
          # è¿™é‡Œçš„ grep æ˜¯ä¸ºäº†å»æ‰å¯èƒ½çš„ç©ºè¡Œï¼Œç¡®ä¿æ–‡æœ¬ç´§å‡‘
          tail -n 6 firmware_output.txt > changelog_body.txt

      - name: Clean and Re-pack
        if: steps.version_check.outputs.update_needed == 'true'
        run: |
          # åˆ é™¤è„šæœ¬ç”Ÿæˆçš„å¯èƒ½åŒ…å«å†—ä½™æ•°æ®çš„ zip
          rm -f *.zip
          
          # æ‰¾åˆ°æ–‡ä»¶å¤¹
          FIRMWARE_FOLDER=$(find . -maxdepth 1 -type d -name "Firmware *" | head -n 1)
          
          if [ -z "$FIRMWARE_FOLDER" ]; then
            exit 1
          fi
          
          # æ‰‹åŠ¨é‡æ–°æ‰“åŒ…ä»¥ç¡®ä¿ä½“ç§¯æ­£å¸¸ (~300MB)
          zip -r -9 -q Firmware.zip "$FIRMWARE_FOLDER"

      - name: Prepare Release Body
        id: prepare_body
        if: steps.version_check.outputs.update_needed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              // è¯»å–æ—¥å¿—æ–‡ä»¶ï¼Œç§»é™¤é¦–å°¾ç©ºç™½å­—ç¬¦
              const body = fs.readFileSync('changelog_body.txt', 'utf8').trim();
              core.setOutput('release_body', body);
            } catch (error) {
              core.setOutput('release_body', 'No details available.');
            }

      - name: Update Latest Release
        if: steps.version_check.outputs.update_needed == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: ${{ steps.version_check.outputs.new_version }}
          body: |
            æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼š${{ steps.version_check.outputs.new_version }}
            è¯¥å›ºä»¶å·²è‡ªåŠ¨ä»ä»»å¤©å ‚å®˜æ–¹æœåŠ¡å™¨ä¸‹è½½ã€æ ¡éªŒå¹¶é‡æ–°æ‰“åŒ…ã€‚
            æ›´æ–°è¯¦æƒ…ï¼š
            ${{ steps.prepare_body.outputs.release_body }}
          files: |
            Firmware.zip
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
